{% comment %}
  Contador Regresivo con Efecto Flip Mejorado
{% endcomment %}

<div class="countdown-banner" style="background-color: {{ section.settings.background_color }};">
  <div class="countdown-container">
    <div class="countdown-text">
      <h2 style="color: {{ section.settings.text_color }};">{{ section.settings.title_text }}</h2>
    </div>
    <div class="countdown-timer">
      <!-- HORAS -->
      <div class="timer-group">
        <div class="flip-clock">
          <div class="digit-container">
            <div class="digit-top" id="hours-top">
              <span>00</span>
            </div>
            <div class="digit-bottom" id="hours-bottom">
              <span>00</span>
            </div>
            <div class="digit-top flip-top" id="hours-flip-top">
              <span>00</span>
            </div>
            <div class="digit-bottom flip-bottom" id="hours-flip-bottom">
              <span>00</span>
            </div>
          </div>
        </div>
        <div class="timer-label">{{ section.settings.hours_label }}</div>
      </div>

      <!-- SEPARADOR -->
      <div class="timer-separator">
        <div class="separator-dot"></div>
        <div class="separator-dot"></div>
      </div>

      <!-- MINUTOS -->
      <div class="timer-group">
        <div class="flip-clock">
          <div class="digit-container">
            <div class="digit-top" id="minutes-top">
              <span>00</span>
            </div>
            <div class="digit-bottom" id="minutes-bottom">
              <span>00</span>
            </div>
            <div class="digit-top flip-top" id="minutes-flip-top">
              <span>00</span>
            </div>
            <div class="digit-bottom flip-bottom" id="minutes-flip-bottom">
              <span>00</span>
            </div>
          </div>
        </div>
        <div class="timer-label">{{ section.settings.minutes_label }}</div>
      </div>

      <!-- SEPARADOR -->
      <div class="timer-separator">
        <div class="separator-dot"></div>
        <div class="separator-dot"></div>
      </div>

      <!-- SEGUNDOS -->
      <div class="timer-group">
        <div class="flip-clock">
          <div class="digit-container">
            <div class="digit-top" id="seconds-top">
              <span>00</span>
            </div>
            <div class="digit-bottom" id="seconds-bottom">
              <span>00</span>
            </div>
            <div class="digit-top flip-top" id="seconds-flip-top">
              <span>00</span>
            </div>
            <div class="digit-bottom flip-bottom" id="seconds-flip-bottom">
              <span>00</span>
            </div>
          </div>
        </div>
        <div class="timer-label">{{ section.settings.seconds_label }}</div>
      </div>
    </div>
  </div>
</div>

<style>
  .countdown-banner {
    width: 100%;
    padding: 15px 0;
    background-color: #FF001D;
  }

  .countdown-container {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 20px;
  }

  .countdown-text {
    width: 50%;
  }

  .countdown-text h2 {
    color: #FFFFFF;
    font-family: 'Montserrat', sans-serif;
    font-size: {{ section.settings.title_size }}px;
    font-weight: 700;
    line-height: 1.2;
    margin: 0;
    text-transform: uppercase;
  }

  .countdown-timer {
    width: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .timer-group {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin: 0 5px;
  }

  /* Flip Clock Styling */
  .flip-clock {
    width: {{ section.settings.timer_size }}px;
    height: {{ section.settings.timer_size }}px;
    position: relative;
    border-radius: {{ section.settings.timer_border_radius }}px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.2);
  }

  .digit-container {
    width: 100%;
    height: 100%;
    position: relative;
    /* Eliminamos cualquier línea divisoria */
  }

  .digit-top,
  .digit-bottom,
  .flip-top,
  .flip-bottom {
    position: absolute;
    left: 0;
    width: 100%;
    height: 50%;
    overflow: hidden;
    display: flex;
    justify-content: center;
    background: white;
  }

  .digit-top span,
  .digit-bottom span,
  .flip-top span,
  .flip-bottom span {
    position: static;
    display: block;
    width: 100%;
    text-align: center;
    color: black;
    font-size: calc({{ section.settings.timer_size }}px * 0.55);
    font-weight: bold;
    line-height: calc({{ section.settings.timer_size }}px * 0.5);
  }

  .digit-top,
  .flip-top {
    top: 0;
    align-items: center;
    justify-content: center;
    border-top-left-radius: {{ section.settings.timer_border_radius }}px;
    border-top-right-radius: {{ section.settings.timer_border_radius }}px;
  }

  .digit-top span,
  .flip-top span {
    position: relative;
    top: auto;
    left: auto;
    width: auto;
    line-height: normal;
  }

  .digit-bottom,
  .flip-bottom {
    bottom: 0;
    align-items: center;
    justify-content: center;
    border-bottom-left-radius: {{ section.settings.timer_border_radius }}px;
    border-bottom-right-radius: {{ section.settings.timer_border_radius }}px;
  }

  .digit-bottom span,
  .flip-bottom span {
    position: relative;
    bottom: auto;
    left: auto;
    width: auto;
    line-height: normal;
  }

  .digit-bottom span,
  .flip-bottom span {
    bottom: 0;
  }

  .flip-top {
    transform-origin: bottom;
    transform: rotateX(90deg);
    z-index: 2;
    backface-visibility: hidden;
  }

  .flip-bottom {
    transform-origin: top;
    transform: rotateX(90deg);
    z-index: 1;
    backface-visibility: hidden;
  }

  /* Animaciones */
  .flipping .flip-top {
    animation: flipTop 0.5s ease-in both;
  }

  .flipping .flip-bottom {
    animation: flipBottom 0.5s ease-out 0.5s both;
  }

  @keyframes flipTop {
    0% {
      transform: rotateX(0deg);
      z-index: 2;
    }
    100% {
      transform: rotateX(-90deg);
      z-index: 0;
    }
  }

  @keyframes flipBottom {
    0% {
      transform: rotateX(90deg);
      z-index: 1;
    }
    100% {
      transform: rotateX(0deg);
      z-index: 2;
    }
  }

  .timer-label {
    color: #FFFFFF;
    font-size: {{ section.settings.label_size }}px;
    margin-top: 8px;
    text-align: center;
  }

  .timer-separator {
    display: flex;
    flex-direction: column;
    justify-content: space-evenly;
    height: {{ section.settings.timer_size }}px;
    padding: 0 8px;
  }

  .separator-dot {
    width: 8px;
    height: 8px;
    background-color: #FFFFFF;
    border-radius: 50%;
  }

  @media screen and (max-width: 768px) {
    .countdown-container {
      flex-direction: column;
    }

    .countdown-text, .countdown-timer {
      width: 100%;
    }

    .countdown-text {
      margin-bottom: 15px;
      text-align: center;
    }

    .countdown-text h2 {
      font-size: calc({{ section.settings.title_size }}px * 0.7);
    }

    .flip-clock {
      width: calc({{ section.settings.timer_size }}px * 0.8);
      height: calc({{ section.settings.timer_size }}px * 0.8);
    }

    .digit-top span,
    .digit-bottom span,
    .flip-top span,
    .flip-bottom span {
      font-size: calc({{ section.settings.timer_size }}px * 0.5);
      line-height: calc({{ section.settings.timer_size }}px * 0.8);
    }

    .timer-separator {
      height: calc({{ section.settings.timer_size }}px * 0.8);
      padding: 0 5px;
    }

    .separator-dot {
      width: 6px;
      height: 6px;
    }
  }

  @media screen and (max-width: 480px) {
    .countdown-text h2 {
      font-size: calc({{ section.settings.title_size }}px * 0.5);
    }

    .flip-clock {
      width: calc({{ section.settings.timer_size }}px * 0.6);
      height: calc({{ section.settings.timer_size }}px * 0.6);
    }

    .digit-top span,
    .digit-bottom span,
    .flip-top span,
    .flip-bottom span {
      font-size: calc({{ section.settings.timer_size }}px * 0.4);
      line-height: calc({{ section.settings.timer_size }}px * 0.6);
    }

    .timer-label {
      font-size: calc({{ section.settings.label_size }}px * 0.8);
    }

    .timer-separator {
      height: calc({{ section.settings.timer_size }}px * 0.6);
      padding: 0 3px;
    }

    .separator-dot {
      width: 4px;
      height: 4px;
    }
  }
</style>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Referencias a los elementos
    const hoursTop = document.getElementById('hours-top');
    const hoursBottom = document.getElementById('hours-bottom');
    const hoursFlipTop = document.getElementById('hours-flip-top');
    const hoursFlipBottom = document.getElementById('hours-flip-bottom');

    const minutesTop = document.getElementById('minutes-top');
    const minutesBottom = document.getElementById('minutes-bottom');
    const minutesFlipTop = document.getElementById('minutes-flip-top');
    const minutesFlipBottom = document.getElementById('minutes-flip-bottom');

    const secondsTop = document.getElementById('seconds-top');
    const secondsBottom = document.getElementById('seconds-bottom');
    const secondsFlipTop = document.getElementById('seconds-flip-top');
    const secondsFlipBottom = document.getElementById('seconds-flip-bottom');

    // Variables para seguimiento
    let currentHours = -1;
    let currentMinutes = -1;
    let currentSeconds = -1;

    // Establecer tiempo de finalización
    let countDownDate;

    {% if section.settings.date_type == 'specific_date' %}
      // Usar fecha específica
      countDownDate = new Date("{{ section.settings.end_date }}").getTime();
    {% else %}
      // Usar duración desde ahora
      countDownDate = new Date();
      countDownDate.setHours(countDownDate.getHours() + {{ section.settings.duration_hours }});
      countDownDate.setMinutes(countDownDate.getMinutes() + {{ section.settings.duration_minutes }});
      countDownDate = countDownDate.getTime();
    {% endif %}

    // Si el timer es persistente, guardar en localStorage
    {% if section.settings.persistent_timer %}
      const storedEndTime = localStorage.getItem('countdownEndTime');
      if (storedEndTime) {
        countDownDate = parseInt(storedEndTime);
      } else {
        localStorage.setItem('countdownEndTime', countDownDate);
      }
    {% endif %}

    // Función para actualizar los dígitos
    function updateDigit(currentEl, nextEl, value) {
      // Formatear el valor con ceros a la izquierda
      value = (value < 10) ? "0" + value : value;

      // Si el valor ya está actualizado, no hacer nada
      if (currentEl.querySelector('span').textContent === value) return;

      // Preparar elementos para animación
      const digitContainer = currentEl.parentElement;

      // Establecer el nuevo valor para los elementos de animación
      nextEl.querySelector('span').textContent = value;

      // Añadir clase para iniciar animación
      digitContainer.classList.add('flipping');

      // Después de la animación, actualizar y restablecer
      setTimeout(function() {
        currentEl.querySelector('span').textContent = value;
        digitContainer.classList.remove('flipping');
      }, 1000);
    }

    // Inicialización inicial
    function initializeDigits(hours, minutes, seconds) {
      const formatValue = (value) => (value < 10) ? "0" + value : value;

      // Establecer valores iniciales
      const hoursValue = formatValue(hours);
      const minutesValue = formatValue(minutes);
      const secondsValue = formatValue(seconds);

      // Actualizar elementos sin animación
      hoursTop.querySelector('span').textContent = hoursValue;
      hoursBottom.querySelector('span').textContent = hoursValue;
      hoursFlipTop.querySelector('span').textContent = hoursValue;
      hoursFlipBottom.querySelector('span').textContent = hoursValue;

      minutesTop.querySelector('span').textContent = minutesValue;
      minutesBottom.querySelector('span').textContent = minutesValue;
      minutesFlipTop.querySelector('span').textContent = minutesValue;
      minutesFlipBottom.querySelector('span').textContent = minutesValue;

      secondsTop.querySelector('span').textContent = secondsValue;
      secondsBottom.querySelector('span').textContent = secondsValue;
      secondsFlipTop.querySelector('span').textContent = secondsValue;
      secondsFlipBottom.querySelector('span').textContent = secondsValue;

      currentHours = hours;
      currentMinutes = minutes;
      currentSeconds = seconds;
    }

    // Hacer la inicialización inicial una sola vez
    setTimeout(function() {
      const now = new Date().getTime();
      const distance = countDownDate - now;

      if (distance <= 0) {
        initializeDigits(0, 0, 0);
      } else {
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        initializeDigits(hours, minutes, seconds);
      }
    }, 100);

    // Actualizar contador cada segundo
    const countdown = setInterval(function() {
      const now = new Date().getTime();
      const distance = countDownDate - now;

      // Si el contador llega a cero
      if (distance <= 0) {
        clearInterval(countdown);

        initializeDigits(0, 0, 0);

        {% if section.settings.hide_after_end %}
        setTimeout(function() {
          document.querySelector('.countdown-banner').style.display = 'none';
        }, 3000);
        {% endif %}

        {% if section.settings.redirect_after_end and section.settings.redirect_url != blank %}
        setTimeout(function() {
          window.location.href = "{{ section.settings.redirect_url }}";
        }, {{ section.settings.redirect_delay }} * 1000);
        {% endif %}

        {% if section.settings.persistent_timer %}
        localStorage.removeItem('countdownEndTime');
        {% endif %}

        return;
      }

      // Cálculo de tiempo
      const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((distance % (1000 * 60)) / 1000);

      // Actualizar sólo si cambian los valores
      if (hours !== currentHours) {
        // Activar el efecto flip cuando cambia el último dígito
        const lastDigitChanged = (hours % 10) !== (currentHours % 10);

        if (currentHours === -1 || lastDigitChanged) {
          updateDigit(hoursTop, hoursFlipTop, hours);
          updateDigit(hoursBottom, hoursFlipBottom, hours);
        } else {
          // Actualizar sin animación
          hoursTop.querySelector('span').textContent = hours < 10 ? "0" + hours : hours;
          hoursBottom.querySelector('span').textContent = hours < 10 ? "0" + hours : hours;
          hoursFlipTop.querySelector('span').textContent = hours < 10 ? "0" + hours : hours;
          hoursFlipBottom.querySelector('span').textContent = hours < 10 ? "0" + hours : hours;
        }
        currentHours = hours;
      }

      if (minutes !== currentMinutes) {
        // Activar el efecto flip cuando cambia el último dígito
        const lastDigitChanged = (minutes % 10) !== (currentMinutes % 10);

        if (currentMinutes === -1 || lastDigitChanged) {
          updateDigit(minutesTop, minutesFlipTop, minutes);
          updateDigit(minutesBottom, minutesFlipBottom, minutes);
        } else {
          // Actualizar sin animación
          minutesTop.querySelector('span').textContent = minutes < 10 ? "0" + minutes : minutes;
          minutesBottom.querySelector('span').textContent = minutes < 10 ? "0" + minutes : minutes;
          minutesFlipTop.querySelector('span').textContent = minutes < 10 ? "0" + minutes : minutes;
          minutesFlipBottom.querySelector('span').textContent = minutes < 10 ? "0" + minutes : minutes;
        }
        currentMinutes = minutes;
      }

      if (seconds !== currentSeconds) {
        // Activar el efecto flip cuando cambia el último dígito
        const lastDigitChanged = (seconds % 10) !== (currentSeconds % 10);

        if (currentSeconds === -1 || lastDigitChanged) {
          updateDigit(secondsTop, secondsFlipTop, seconds);
          updateDigit(secondsBottom, secondsFlipBottom, seconds);
        } else {
          // Actualizar sin animación
          secondsTop.querySelector('span').textContent = seconds < 10 ? "0" + seconds : seconds;
          secondsBottom.querySelector('span').textContent = seconds < 10 ? "0" + seconds : seconds;
          secondsFlipTop.querySelector('span').textContent = seconds < 10 ? "0" + seconds : seconds;
          secondsFlipBottom.querySelector('span').textContent = seconds < 10 ? "0" + seconds : seconds;
        }
        currentSeconds = seconds;
      }
    }, 1000);
  });
</script>

{% schema %}
{
  "name": "Contador Regresivo",
  "settings": [
    {
      "type": "color",
      "id": "background_color",
      "label": "Color de fondo",
      "default": "#FF001D"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "Color de texto",
      "default": "#FFFFFF"
    },
    {
      "type": "text",
      "id": "title_text",
      "label": "Texto del título",
      "default": "FALTA POCO TIEMPO PARA QUE ESTA OFERTA TERMINE"
    },
    {
      "type": "range",
      "id": "title_size",
      "min": 16,
      "max": 60,
      "step": 1,
      "label": "Tamaño del título (px)",
      "default": 32
    },
    {
      "type": "select",
      "id": "date_type",
      "label": "Tipo de cuenta regresiva",
      "options": [
        {
          "value": "duration",
          "label": "Duración desde ahora"
        },
        {
          "value": "specific_date",
          "label": "Fecha específica"
        }
      ],
      "default": "duration"
    },
    {
      "type": "text",
      "id": "end_date",
      "label": "Fecha final (YYYY-MM-DD)",
      "default": "2025-12-31"
    },
    {
      "type": "number",
      "id": "duration_hours",
      "label": "Duración (horas)",
      "default": 24
    },
    {
      "type": "number",
      "id": "duration_minutes",
      "label": "Duración (minutos adicionales)",
      "default": 0
    },
    {
      "type": "checkbox",
      "id": "persistent_timer",
      "label": "Persistir temporizador entre visitas",
      "default": true
    },
    {
      "type": "text",
      "id": "hours_label",
      "label": "Etiqueta para horas",
      "default": "Horas"
    },
    {
      "type": "text",
      "id": "minutes_label",
      "label": "Etiqueta para minutos",
      "default": "Minutos"
    },
    {
      "type": "text",
      "id": "seconds_label",
      "label": "Etiqueta para segundos",
      "default": "Segundos"
    },
    {
      "type": "range",
      "id": "timer_size",
      "min": 40,
      "max": 120,
      "step": 5,
      "label": "Tamaño del temporizador (px)",
      "default": 75
    },
    {
      "type": "range",
      "id": "timer_border_radius",
      "min": 0,
      "max": 20,
      "step": 1,
      "label": "Radio de borde",
      "default": 0
    },
    {
      "type": "range",
      "id": "label_size",
      "min": 10,
      "max": 24,
      "step": 1,
      "label": "Tamaño de etiquetas (px)",
      "default": 14
    },
    {
      "type": "checkbox",
      "id": "hide_after_end",
      "label": "Ocultar al finalizar",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "redirect_after_end",
      "label": "Redirigir al finalizar",
      "default": false
    },
    {
      "type": "url",
      "id": "redirect_url",
      "label": "URL de redirección"
    },
    {
      "type": "number",
      "id": "redirect_delay",
      "label": "Retraso antes de redirigir (segundos)",
      "default": 0
    }
  ],
  "presets": [
    {
      "name": "Contador Regresivo",
      "category": "Promoción"
    }
  ]
}
{% endschema %}
